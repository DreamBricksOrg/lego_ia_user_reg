<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultado</title>
    <link rel="stylesheet" href="{{ url_for('templates_lego_css', path='base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('templates_lego_css', path='resultado.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div id="image-overlay">
    <img id="zoomed-img" src="" alt="Zoom" />
  </div>
  <div class="container">
    <div class="header">
      <img src="{{ url_for('templates_lego_assets', path='images/logo.png') }}" alt="Logo">
    </div>
    <div class="content">
      <h1>AQUI ESTA A SUA IMAGEM!</h1>
      <div class="drawing-container">
        <img id="drawing-image" src="{{ image_url }}" alt="Sua imagem">
      </div>

      <div class="buttons">
      <img src="{{ url_for('templates_lego_assets', path='images/compartilhar.png') }}" onclick="shareImage()" class="button" id="share-btn">
        </img>
      <img src="{{ url_for('templates_lego_assets', path='images/baixar.png') }}" onclick="downloadImage()" class="button" id="download-btn">
        </img>
      </div>
    </div>
  </div>

  <script>
    // Define a imagem a partir do query param `image_url` (fallback para template var)
    document.addEventListener('DOMContentLoaded', () => {
      sendLog('TELA_RESULTADO').catch(() => {});
      const imgEl = document.getElementById('drawing-image');
      const params = new URLSearchParams(window.location.search);
      const qp = params.get('image_url');
      if (qp) {
        try {
          const decoded = decodeURIComponent(qp);
          imgEl.src = decoded;
        } catch (e) {
          console.error('Falha ao decodificar image_url:', e);
        }
      }

      if (!imgEl.src) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('Imagem não encontrada', "Informe o parâmetro 'image_url' na URL.", 'warning');
        } else {
          console.warn("Imagem não encontrada. Informe o parâmetro 'image_url' na URL.");
        }
      }

      // Log: acesso à página de resultado / QRCode
      sendLog('SERVIDOR_ACESSOU_RESULTADO').catch(() => {});
    });

    const processedImage = document.getElementById("drawing-image");
    const overlay = document.getElementById("image-overlay");
    const zoomedImg = document.getElementById("zoomed-img");

    processedImage.addEventListener("click", (event) => {
      event.stopPropagation();
      zoomedImg.src = processedImage.src;
      overlay.classList.add("visible");
    });

    overlay.addEventListener("click", () => {
      overlay.classList.remove("visible");
    });
  </script>
  <script>
    async function sendLog(message, extraData = {}) {
      try {
        const params = new URLSearchParams(window.location.search);
        const sid = params.get('sid') || undefined;
        const payload = {
          message,
          level: 'INFO',
          sessionId: sid,
          data: {
            image_url: document.getElementById('drawing-image')?.src || null,
            path: window.location.pathname,
            ...extraData,
          },
        };
        await fetch('/log/create-log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
      } catch (err) {
        console.warn('Falha ao enviar log', message, err);
      }
    }

    async function downloadImage() {
      // Log: clique no botão de download
      sendLog('SERVIDOR_BAIXOU_IMAGEM').catch(() => {});

      const image = document.querySelector('#drawing-image');
      if (!image || !image.src) {
        Swal.fire("Imagem não encontrada", "Não conseguimos carregar sua imagem. Tente novamente.", "error");
        return;
      }

      try {
        const response = await fetch(image.src, {
          mode: 'cors',
          headers: {
            "Cache-Control": "no-cache",
            "Pragma": "no-cache"
          }
        });
        const blob = await response.blob();

        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const random_int = Math.floor(Math.random() * 90000) + 10000;

        link.href = blobUrl;
        link.download = `${random_int}_lego.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(blobUrl);
      } catch (error) {
        console.error("Erro ao baixar imagem:", error);
        Swal.fire("Falha no download", "Não foi possível baixar a imagem. Tente novamente mais tarde.", "error");
      }
    }

    async function shareImage() {
      // Log: clique no botão de compartilhar
      sendLog('SERVIDOR_COMPARTILHOU_IMAGEM').catch(() => {});

      try {
        const image = document.querySelector('#drawing-image');
        const response = await fetch(image.src, {
          headers: {
            "Cache-Control": "no-cache",
            "Pragma": "no-cache"
          }
        });
        const blob = await response.blob();
        const file = new File([blob], 'lego.png', { type: 'image/png' });

        if (navigator.share) {
          await navigator.share({
            files: [file],
            title: 'Meu desenho Lego',
            text: 'Confira minha imagem Lego!'
          });
        } else {
          Swal.fire("Compartilhamento indisponível", "Este navegador não permite compartilhamento de arquivos.", "warning");
        }
      } catch (error) {
        console.error('Erro ao compartilhar:', error);
        Swal.fire("Falha no compartilhamento", "Não foi possível compartilhar a imagem. Tente novamente mais tarde.", "error");
      }
    }
  </script>
</body>

</html>