<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultado</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/resultado.css') }}" />
</head>

<body>
  <div id="image-overlay">
    <img id="zoomed-img" src="" alt="Zoom" />
  </div>
  <div class="container">
    <div class="header">
      <img src="/static/images/logo.png" alt="Logo">
    </div>
    <div class="content">
      <h1>AQUI ESTA A SUA IMAGEM!</h1>
      <div class="drawing-container">
        <img id="drawing-image" src="{{ image_url }}" alt="Sua imagem">
      </div>

      <div class="buttons">
        <img src="/static/images/compartilhar.png" onclick="shareImage()" class="button" id="share-btn">
        </img>
        <img src="/static/images/baixar.png" onclick="downloadImage()" class="button" id="download-btn">
        </img>
      </div>
    </div>
  </div>

  <script>
    const processedImage = document.getElementById("drawing-image");
    const overlay = document.getElementById("image-overlay");
    const zoomedImg = document.getElementById("zoomed-img");

    processedImage.addEventListener("click", (event) => {
      event.stopPropagation();
      zoomedImg.src = processedImage.src;
      overlay.classList.add("visible");
    });

    overlay.addEventListener("click", () => {
      overlay.classList.remove("visible");
    });
  </script>
  <script>
    async function downloadImage() {
      const image = document.querySelector('#drawing-image');
      if (!image || !image.src) {
        Swal.fire("Imagem não encontrada", "Não conseguimos carregar sua imagem. Tente novamente.", "error");
        return;
      }

      try {
        const response = await fetch(image.src, {
          mode: 'cors',
          headers: {
            "Cache-Control": "no-cache",
            "Pragma": "no-cache"
          }
        });
        const blob = await response.blob();

        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const random_int = Math.floor(Math.random() * 90000) + 10000;

        link.href = blobUrl;
        link.download = `${random_int}_lego.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(blobUrl);
      } catch (error) {
        console.error("Erro ao baixar imagem:", error);
        Swal.fire("Falha no download", "Não foi possível baixar a imagem. Tente novamente mais tarde.", "error");
      }
    }

    async function shareImage() {
      try {
        const image = document.querySelector('#drawing-image');
        const response = await fetch(image.src, {
          headers: {
            "Cache-Control": "no-cache",
            "Pragma": "no-cache"
          }
        });
        const blob = await response.blob();
        const file = new File([blob], 'lego.png', { type: 'image/png' });

        if (navigator.share) {
          await navigator.share({
            files: [file],
            title: 'Meu desenho Lego',
            text: 'Confira minha imagem Lego!'
          });
        } else {
          Swal.fire("Compartilhamento indisponível", "Este navegador não permite compartilhamento de arquivos.", "warning");
        }
      } catch (error) {
        console.error('Erro ao compartilhar:', error);
        Swal.fire("Falha no compartilhamento", "Não foi possível compartilhar a imagem. Tente novamente mais tarde.", "error");
      }
    }
  </script>
</body>

</html>