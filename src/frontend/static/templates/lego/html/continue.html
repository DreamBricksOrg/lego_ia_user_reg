<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Continue</title>
  <link rel="stylesheet" href="{{ url_for('templates_lego_css', path='base.css') }}" />
  <link rel="stylesheet" href="{{ url_for('templates_lego_css', path='continue.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div class="container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const params = new URLSearchParams(window.location.search);
      const sid = params.get('sid');
      if (!sid) {
        if (window.Swal && typeof window.Swal.fire === 'function') {
          await Swal.fire('Sessão não encontrada', 'Parâmetro "sid" ausente na URL.', 'error');
        } else {
          alert('Sessão não encontrada: parâmetro "sid" ausente na URL.');
        }
        return;
      }


      try {
        const sResp = await fetch(`/totem/session/${encodeURIComponent(sid)}`);
        let sData = {};
        try { sData = await sResp.json(); } catch (_) { }
        if (!sResp.ok) {
          const errText = (sData && sData.detail) ? String(sData.detail) : `Status ${sResp.status}`;
          if (window.Swal && typeof window.Swal.fire === 'function') {
            await Swal.fire('Sessão não encontrada', errText, 'error');
          } else {
            console.warn('Sessão não encontrada: ' + errText);
          }
          return;
        }
        // Se a sessão já estiver encerrada, interrompe fluxo e navega para /api/lego/erro
        if (String(sData?.step || '').toLowerCase() === 'closed') {
          const target = new URL('/api/lego/erro', window.location.origin);
          target.search = window.location.search; // preserva query params
          window.location.assign(target.toString());
          return;
        }
        // Disponibiliza dados da sessão para scripts futuros
        window.__sessionData = sData;
      } catch (err) {
        if (window.Swal && typeof window.Swal.fire === 'function') {
          await Swal.fire('Erro de rede', String(err), 'error');
        } else {
          alert('Erro de rede: ' + String(err));
        }
        return;
      }

      // Chama /totem/session/continue
      try {
        const cResp = await fetch('/totem/session/continue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sid }),
        });
        let cData = {};
        try { cData = await cResp.json(); } catch (_) { }
        if (!cResp.ok) {
          const errText = (cData && cData.detail) ? String(cData.detail) : `Status ${cResp.status}`;
          if (window.Swal && typeof window.Swal.fire === 'function') {
            await Swal.fire('Sessão já encerrada', "", 'error');
          } else {
            alert('Erro ao continuar sessão: ' + "");
          }
          return;
        }
      } catch (err) {
        if (window.Swal && typeof window.Swal.fire === 'function') {
          await Swal.fire('Erro de rede', String(err), 'error');
        } else {
          alert('Erro de rede: ' + String(err));
        }
        return;
      }

      // Em seguida, chama /totem/authorize
      try {
        const aResp = await fetch('/totem/authorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sid }),
        });
        let aData = {};
        try { aData = await aResp.json(); } catch (_) { }
        if (aResp.ok && (aData?.ok ?? true)) {
          if (window.Swal && typeof window.Swal.fire === 'function') {
            await Swal.fire('Autorizado', 'Aguarde as instruções no totem.', 'success');
          }
        } else {
          const errText = (aData && aData.detail) ? String(aData.detail) : `Status ${aResp.status}`;
          if (window.Swal && typeof window.Swal.fire === 'function') {
            await Swal.fire('Falha na autorização', errText, 'error');
          } else {
            alert('Falha na autorização: ' + errText);
          }
        }
      } catch (err) {
        if (window.Swal && typeof window.Swal.fire === 'function') {
          await Swal.fire('Erro de rede', String(err), 'error');
        } else {
          alert('Erro de rede: ' + String(err));
        }
      }

      try {
        await fetch('/totem/session/close', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sid }),
        });
      } catch (err) {
        console.warn('Sessão já encerrada');
      }
    });
  </script>
</body>

</html>