<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyn - Formulário</title>
    <link rel="stylesheet" href="/templates/skyn/css/skyn-root.css">
    <link rel="stylesheet" href="/templates/skyn/css/form.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="container">

        <div class="header">
            <img src="/templates/skyn/assets/images/skyn_logo.png" alt="Skyn Logo">
        </div>

        <div class="content">

            <div class="title">
                <p>PREENCHA OS CAMPOS ABAIXO</p>
                <P>E RETIRE SUA AMOSTRA</P>
            </div>

            <form id="formulario">
                <div class="form-content">
                    <label for="nome" class="form-label">NOME COMPLETO</label>
                    <input type="text" id="nome" name="nome" class="form-input" autocomplete="off" required>
                    <div id="nome-erro" class="form-error" style="display:none;"></div>

                    <label for="email" class="form-label">E-MAIL</label>
                    <input type="email" id="email" name="email" class="form-input" autocomplete="off" required>
                    <div id="email-erro" class="form-error" style="display:none;"></div>
                </div>
                <div class="button-container">
                    <button class="btn" id="btn-enviar" type="submit" disabled>ENVIAR</button>
                </div>
            </form>

            <div class="image-container">
                <img src="/templates/skyn/assets/images/product.png" alt="">
            </div>

        </div>
    </div>

    <script>
        // Função para validar e-mail
        function validarEmail(email) {
            // Regex simples para validação de e-mail
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Função para validar nome (não vazio e pelo menos 2 palavras)
        function validarNome(nome) {
            return nome.trim().length > 0 && nome.trim().split(' ').length >= 2;
        }

        const nomeInput = document.getElementById('nome');
        const emailInput = document.getElementById('email');
        const btnEnviar = document.getElementById('btn-enviar');
        const nomeErro = document.getElementById('nome-erro');
        const emailErro = document.getElementById('email-erro');
        const formulario = document.getElementById('formulario');

        const COLLECTION = 'skyn_elite';

        // Função para capturar parâmetros da URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Função para salvar session_id e slug no localStorage
        function saveSessionData() {
            const sessionId = getUrlParameter('sid');
            const slug = getUrlParameter('slug');

            // Se não há session_id no localStorage, tenta pegar da URL
            if (!localStorage.getItem('session_id') && sessionId) {
                localStorage.setItem('session_id', sessionId);
                console.log('Session ID salvo da URL:', sessionId);
            } else if (localStorage.getItem('session_id')) {
                console.log('Session ID já existe no localStorage:', localStorage.getItem('session_id'));
            } else {
                console.log('Nenhum session_id encontrado na URL ou localStorage');
            }

            // Se não há slug no localStorage, tenta pegar da URL
            if (!localStorage.getItem('slug') && slug) {
                localStorage.setItem('slug', slug);
                console.log('Slug salvo da URL:', slug);
            } else if (localStorage.getItem('slug')) {
                console.log('Slug já existe no localStorage:', localStorage.getItem('slug'));
            } else {
                console.log('Nenhum slug encontrado na URL ou localStorage');
            }
        }

        // Executa quando a página carrega
        document.addEventListener('DOMContentLoaded', function () {
            saveSessionData();
        });

        function validarCampos() {
            let nomeValido = validarNome(nomeInput.value);
            let emailValido = validarEmail(emailInput.value);

            // Validação do nome
            if (!nomeValido && nomeInput.value.trim() !== "") {
                nomeErro.textContent = "Por favor, informe o nome completo.";
                nomeErro.style.display = "block";
                nomeInput.classList.add("invalid");
            } else {
                nomeErro.textContent = "";
                nomeErro.style.display = "none";
                nomeInput.classList.remove("invalid");
            }

            // Validação do e-mail
            if (!emailValido && emailInput.value.trim() !== "") {
                emailErro.textContent = "E-mail inválido.";
                emailErro.style.display = "block";
                emailInput.classList.add("invalid");
            } else {
                emailErro.textContent = "";
                emailErro.style.display = "none";
                emailInput.classList.remove("invalid");
            }

            // Habilita o botão apenas se ambos forem válidos
            btnEnviar.disabled = !(nomeValido && emailValido);
        }

        nomeInput.addEventListener('input', validarCampos);
        emailInput.addEventListener('input', validarCampos);

        async function tryCreateUser(payload) {
            const res = await fetch(`/api/users/?collection=${COLLECTION}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            return { ok: res.ok, status: res.status, data, statusText: res.statusText };
        }

        async function tryRegisterPickup(email) {
            const today = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const pickupPayload = {
                email: email,
                day: today,
                condomsPicked: 1
            };

            const res = await fetch(`/api/users/pickup/?collection=${COLLECTION}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pickupPayload)
            });
            const data = await res.json().catch(() => ({}));
            return { ok: res.ok, status: res.status, data, statusText: res.statusText };
        }

        formulario.addEventListener('submit', async function (e) {
            e.preventDefault();
            validarCampos();
            if (btnEnviar.disabled) {
                return;
            }

            // Monta o payload a partir do formulário
            const sessionId = localStorage.getItem('session_id') || '';
            const payload = {
                name: nomeInput.value.trim(),
                email: emailInput.value.trim(),
                code: sessionId
            };

            try {
                const res = await tryCreateUser(payload);

                if (res.ok) {
                    const pickupRes = await tryRegisterPickup(payload.email);

                    // Redireciona com query params imediatamente
                    const urlParams = new URLSearchParams(window.location.search);
                    const queryString = urlParams.toString();
                    const claimUrl = queryString ? `/api/skyn/claim?${queryString}` : '/api/skyn/claim';
                    window.location.href = claimUrl;
                } else if (res.status === 409) {
                    // E-mail já cadastrado, tenta registrar pickup mesmo assim
                    const pickupRes = await tryRegisterPickup(payload.email);

                    // Redireciona com query params imediatamente
                    const urlParams = new URLSearchParams(window.location.search);
                    const queryString = urlParams.toString();
                    const claimUrl = queryString ? `/api/skyn/claim?${queryString}` : '/api/skyn/claim';
                    window.location.href = claimUrl;
                } else {
                    const msg = (res.data && (res.data.detail || res.data.message)) || res.statusText || 'Erro ao cadastrar';
                    await Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: msg,
                        confirmButtonText: 'OK'
                    });
                }
            } catch (err) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Ocorreu um erro inesperado. Tente novamente.',
                    confirmButtonText: 'OK'
                });
            }
        });
    </script>
</body>

</html>