<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Admin ‚Äî Skyn Elite</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/design/tokens.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>ü•§</text></svg>">
  <style>
    .wrap { max-width: 1100px; margin: 48px auto; padding: 0 16px; }
    .card { background: var(--color-surface); color:#0A0A0A; border-radius: var(--radius-lg); padding: 24px; }
    .muted { opacity:.75; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    label { display:block; font-size:14px; margin: 8px 0 6px; }
    .bar { display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top: 12px; }
    .out { margin-top:16px; background:#f6f7f8; border-radius: var(--radius-sm); padding: 12px; white-space: pre-wrap; font-size: 13px; }
    .table-wrap { margin-top:16px; overflow-x:auto; -webkit-overflow-scrolling: touch; }
    table { border-collapse: collapse; min-width: 980px; width: 100%; }
    th, td { border-bottom:1px solid #e6e8ea; padding:10px; font-size:14px; text-align:left; white-space: nowrap; }
    th { color:#5b6166; font-weight:600; }
    .right { text-align:right; }
    .pager { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; }

    /* Modal do iframe */
    .iframe-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .iframe-container {
      width: 90%; height: 90%; background: #fff; border-radius: var(--radius-lg);
      overflow: hidden; display: flex; flex-direction: column;
    }
    .iframe-header {
      padding: 8px 16px; background: var(--color-brand); color: var(--color-text-on-button);
      display: flex; justify-content: space-between; align-items: center;
    }
    .iframe-header button {
      background: none; border: none; color: inherit; font-size: 20px; cursor: pointer;
    }
    .iframe-body { flex: 1; }
    .iframe-body iframe { border: none; width: 100%; height: 100%; }
    @media (max-width: 768px) {
      .wrap { margin: 16px auto; padding: 0 8px; }
      .card { padding: 16px; border-radius: var(--radius-md); }
      .bar { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      .pager { justify-content: center; }
    }
    @media (max-width: 480px) {
      .wrap { margin: 8px auto; padding: 0 6px; }
      .card { padding: 14px; }
      .bar { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1 class="h-heading" style="margin:0 0 8px;">Administra√ß√£o</h1>
      <p class="muted" style="margin:0 0 16px;">Crie, liste, filtre e exporte os cadastros.</p>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
        <button class="btn-primary" id="btnOpenUser">Abrir Formul√°rio de Cadastro</button>
      </div>

      <div class="bar">
        <div style="flex:1; min-width:220px;">
          <label for="name">Filtro por nome</label>
          <input class="input" id="name" type="text" placeholder="ex.: Ana" />
        </div>
        <div style="flex:1; min-width:220px;">
          <label for="email">Filtro por email</label>
          <input class="input" id="email" type="email" placeholder="ex.: ana@exemplo.com" />
        </div>
        <div>
          <label for="from">De</label>
          <input class="input" id="from" type="date" />
        </div>
        <div>
          <label for="to">At√©</label>
          <input class="input" id="to" type="date" />
        </div>
        <div>
          <label for="page_size">Page size</label>
          <select class="input" id="page_size">
            <option>10</option><option selected>20</option><option>50</option><option>100</option>
          </select>
        </div>
        <div>
          <button class="btn-primary" id="btnListar">Listar</button>
        </div>
        <div>
          <button class="btn-primary" id="btnExport">Export CSV</button>
        </div>
      </div>

      <pre id="log" class="out" aria-live="polite"></pre>

      <div class="table-wrap">
        <table id="users">
          <thead>
            <tr>
              <th>Nome</th><th>Email</th><th>Status</th><th class="right">Preservativos</th>
              <th>Data de Nascimento</th><th>Registro</th><th>Resgatado</th><th>Pode Resgatar Novamente</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pager">
        <button class="btn-primary" id="prev">‚óÄ</button>
        <span class="muted">P√°gina <span id="pg">1</span></span>
        <button class="btn-primary" id="next">‚ñ∂</button>
      </div>
    </section>
  </main>

  <!-- Modal com o user.html -->
  <div class="iframe-modal" id="iframeModal">
    <div class="iframe-container">
      <div class="iframe-header">
        <span>Cadastro de Usu√°rio</span>
        <button id="btnCloseIframe">&times;</button>
      </div>
      <div class="iframe-body">
        <iframe id="userFrame" src="/templates/user.html" referrerpolicy="no-referrer"></iframe>
      </div>
      <div class="iframe-footer" style="padding:8px; text-align:right; background:#f6f7f8;">
        <button id="btnCloseIframeFooter" class="btn-primary">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const logOut = document.getElementById('log');
    const tbody = document.querySelector('#users tbody');
    const pgSpan = document.getElementById('pg');
    let page = 1;

    const qs = (id) => document.getElementById(id);
    const getToken = () => localStorage.getItem('adminToken') || '';
    const ensureToken = () => {
      const t = getToken();
      if (!t) {
        localStorage.removeItem('adminToken');
        window.location.href = '/templates/login.html';
        return null;
      }
      return t;
    };

    // ---- helpers: status & datas ----
    function translateStatus(s) {
      const map = { registered: 'Cadastrado', eligible: 'Eleg√≠vel', picked: 'Resgatado' };
      if (!s) return '';
      const key = String(s).toLowerCase();
      return map[key] ?? s;
    }
    function fmtDate(v) {
      if (!v) return '';
      if (v instanceof Date) return v.toISOString().slice(0,10);
      const str = String(v);
      return str.length >= 10 ? str.slice(0,10) : str;
    }

    // ---- IFRAME/MODAL ----
    const modal = document.getElementById('iframeModal');
    const btnOpen = document.getElementById('btnOpenUser');
    const btnClose = document.getElementById('btnCloseIframe');
    const btnCloseFooter = document.getElementById('btnCloseIframeFooter');
    const iframe = document.getElementById('userFrame');

    const openModal = () => { modal.style.display = 'flex'; };
    const closeModal = () => {
      modal.style.display = 'none';
      iframe.contentWindow?.postMessage('limpar_log', '*'); // limpa log do iframe ao fechar
    };

    btnOpen.addEventListener('click', openModal);
    btnClose.addEventListener('click', closeModal);
    btnCloseFooter.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    window.addEventListener('message', (event) => {
      if (event.data === 'cadastro_concluido') {
        closeModal();
        page = 1;
        loadUsers();
      }
    });

    iframe.addEventListener('error', () => {
      console.error('Falha ao carregar o iframe:', iframe.src);
      fetch(iframe.src).then(r => console.log('Fetch para iframe:', r.status));
    });

    // ---- LISTAGEM ----
    function rowsFromResponse(payload) {
      if (payload && Array.isArray(payload.data)) return payload.data;
      if (Array.isArray(payload)) return payload;
      return [];
    }

    async function loadUsers() {
      logOut.textContent = 'Consultando usu√°rios...\n';
      const token = ensureToken();
      if (!token) return;

      const params = new URLSearchParams();
      const name = qs('name').value.trim();
      const email = qs('email').value.trim();
      const from = qs('from').value;
      const to = qs('to').value;
      const page_size = qs('page_size').value;

      if (name) params.set('name', name);
      if (email) params.set('email', email);
      if (from) params.set('date_from', from);
      if (to) params.set('date_to', to);
      params.set('page', String(page));
      params.set('page_size', page_size);

      try {
        const res = await fetch(`/api/admin/users?${params.toString()}`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
          localStorage.removeItem('adminToken');
          window.location.href = '/templates/login.html';
          return;
        }

        const data = await res.json();
        const rows = rowsFromResponse(data);

        logOut.textContent += `Total encontrados: ${typeof data.total === 'number' ? data.total : rows.length}\n`;
        if (data.page) pgSpan.textContent = String(data.page);

        tbody.innerHTML = '';
        if (!rows.length) {
          logOut.textContent += 'Sem resultados para estes filtros.\n';
          return;
        }

        for (const u of rows) {
          const row = `<tr>
            <td>${u.name ?? ''}</td>
            <td>${u.email ?? ''}</td>
            <td>${translateStatus(u.status)}</td>
            <td class="right">${u.condomsPicked ?? 0}</td>
            <td>${fmtDate(u.birthDate)}</td>
            <td>${fmtDate(u.registerDay)}</td>
            <td>${fmtDate(u.pickedDay)}</td>
            <td>${fmtDate(u.canPickFrom)}</td>
          </tr>`;
          tbody.insertAdjacentHTML('beforeend', row);
        }
        logOut.textContent += 'Listagem conclu√≠da.';
      } catch (err) {
        logOut.textContent += `Erro: ${err.message}`;
      }
    }

    async function exportCsv() {
      const token = ensureToken();
      if (!token) return;

      const params = new URLSearchParams();
      const name = qs('name').value.trim();
      const email = qs('email').value.trim();
      const from = qs('from').value;
      const to = qs('to').value;

      if (name) params.set('name', name);
      if (email) params.set('email', email);
      if (from) params.set('date_from', from);
      if (to) params.set('date_to', to);

      const res = await fetch(`/api/admin/users/export?${params.toString()}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.status === 401) {
        localStorage.removeItem('adminToken');
        window.location.href = '/templates/login.html';
        return;
      }

      if (!res.ok) {
        const t = await res.text();
        logOut.textContent = `Erro no export: ${t || res.status}`;
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'users.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('btnListar').addEventListener('click', () => { page = 1; loadUsers(); });
    document.getElementById('btnExport').addEventListener('click', exportCsv);
    document.getElementById('prev').addEventListener('click', () => { if (page>1){ page--; loadUsers(); } });
    document.getElementById('next').addEventListener('click', () => { page++; loadUsers(); });

    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('adminToken')) {
        page = 1;
        loadUsers();
      }
    });
  </script>

</body>
</html>
